events {}

http {
    # --- Map for Real Client IP ---
    map $http_x_real_ip $client_ip {
        default $http_x_real_ip;
        ""      $remote_addr;
    }

    # Define the upstream Node.js app
    upstream node_app {
        server 127.0.0.1:3000;
    }

    # Custom log format to capture the *real* IP and timestamp
    log_format hls_log '$client_ip - [$time_local]';

    # --- NEW: Global MIME types for streaming ---
    # We define these at the http level so all server blocks inherit them.
    types {
        application/vnd.apple.mpegurl m3u8;
        video/mp2t ts;
        application/dash+xml mpd;
        video/mp4 m4s mp4;
    }

    # Server 1: The UI Control Panel on port 8995
    server {
        listen 8995;

        location / {
            proxy_pass http://node_app;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
    }

    # Server 2: The HLS/DASH Stream on port 8994
    server {
        listen 8994;

        # Include the dynamic blocklist file.
        include /etc/nginx/blocklist.conf;

        # Default location for all files (including /buffer/ subdirectory)
        location / {
            root /var/www/hls;
            add_header 'Access-Control-Allow-Origin' '*';
            add_header 'Cache-Control' 'no-cache, no-store';
        }

        # --- MODIFIED: Specific logging for HLS playlists ---
        # This regex matches /live.m3u8 and /local_playlist.m3u8
        location ~ \.m3u8$ {
            root /var/www/hls;
            add_header 'Access-Control-Allow-Origin' '*';
            add_header 'Cache-Control' 'no-cache, no-store';
            access_log /var/log/nginx/hls_access.log hls_log;
        }
        
        # --- NEW: Specific logging for MPD manifests ---
        # This regex matches /local_manifest.mpd
        location ~ \.mpd$ {
            root /var/www/hls;
            add_header 'Access-Control-Allow-Origin' '*';
            add_header 'Cache-Control' 'no-cache, no-store';
            access_log /var/log/nginx/hls_access.log hls_log;
        }

        # --- MODIFIED: Specific logging for HLS segments ---
        # This regex matches /segment_001.ts and /buffer/some_segment.ts
        location ~ \.ts$ {
            root /var/www/hls;
            add_header 'Access-Control-Allow-Origin' '*';
            add_header 'Cache-Control' 'no-cache, no-store';
            access_log /var/log/nginx/hls_access.log hls_log;
        }

        # --- NEW: Specific logging for MPD segments ---
        # This regex matches /buffer/segment.m4s and /buffer/init.mp4
        location ~ \.(m4s|mp4)$ {
            root /var/www/hls;
            add_header 'Access-Control-Allow-Origin' '*';
            add_header 'Cache-Control' 'no-cache, no-store';
            access_log /var/log/nginx/hls_access.log hls_log;
        }
    }
}

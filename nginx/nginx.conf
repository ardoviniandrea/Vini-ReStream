events {}

http {
    # --- MODIFIED: More aggressive cache disabling for the 404 fix ---
    sendfile off;
    sendfile_max_chunk 1k;  # Force smaller, more frequent disk reads
    open_file_cache off;    # Disable all file caching
    expires -1;             # Force assets to expire immediately
    # --- END MODIFICATION ---

    # --- NEW: Map for Real Client IP ---
    # Creates a new variable $client_ip.
    # If $http_x_real_ip is set (by Nginx Proxy Manager), use it.
    # Otherwise, fall back to the direct connection's IP ($remote_addr).
    map $http_x_real_ip $client_ip {
        default $http_x_real_ip;
        ""      $remote_addr;
    }

    # Define the upstream Node.js app (running on port 3000 inside the container)
    upstream node_app {
        server 127.0.0.1:3000;
    }

    # --- MODIFIED: Use $client_ip ---
    # Custom log format to capture the *real* IP and timestamp
    log_format hls_log '$client_ip - [$time_local]';

    # Server 1: The UI Control Panel on port 8995
    server {
        listen 8995;

        # All requests to the UI port are proxied to the Node.js app
        location / {
            proxy_pass http://node_app;
            proxy_set_header Host $host;
            # We also pass the real IP to the Node app, just in case
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
    }

    # Server 2: The HLS Stream on port 8994
    server {
        listen 8994;

        # --- NEW ---
        # Include the dynamic blocklist file.
        # The Node app will add 'deny 1.2.3.4;' lines to this file.
        include /etc/nginx/blocklist.conf;

        # --- MODIFIED: Specific rule for the local MPD manifest ---
        # This fixes the 404 error by telling Nginx how to serve the .mpd file
        # Using 'alias' is more explicit than 'root' for a single file.
        location = /local_manifest.mpd {
            alias /var/www/hls/local_manifest.mpd; # Use alias for a specific file path
            add_header 'Access-Control-Allow-Origin' '*';
            add_header 'Cache-Control' 'no-cache, no-store, must-revalidate'; # Be explicit
            add_header 'Pragma' 'no-cache';
            add_header 'Expires' '0';
            types {
                application/dash+xml mpd;
            }
            # This file is requested by ffmpeg, not users, so no access log
        }
        # --- END MODIFICATION ---

        # --- NEW: Specific rule for the HLS buffer directory ---
        # This will be needed if you re-enable the HLS buffer
        location /buffer/ {
            root /var/www/hls;
            add_header 'Access-Control-Allow-Origin' '*';
            add_header 'Cache-Control' 'no-cache, no-store';
            types {
                video/mp2t ts;
            }
        }

        # Specific headers for the HLS playlist
        location = /live.m3u8 {
            root /var/www/hls;
            add_header 'Access-Control-Allow-Origin' '*';
            add_header 'Cache-Control' 'no-cache, no-store';
            types {
                application/vnd.apple.mpegurl m3u8;
            }
            # --- MODIFIED ---
            # This will now use the new 'hls_log' format defined above
            access_log /var/log/nginx/hls_access.log hls_log;
        }
        
        # Specific headers for the HLS video segments
        location ~ \.ts$ {
            root /var/www/hls;
            add_header 'Access-Control-Allow-Origin' '*';
            add_header 'Cache-Control' 'no-cache, no-store';
            types {
                video/mp2t ts;
            }
            # --- MODIFIED ---
            # This will also use the new 'hls_log' format
            access_log /var/log/nginx/hls_access.log hls_log;
        }

        # All other files are served directly from the shared HLS directory
        # This is the fallback location.
        location / {
            root /var/www/hls;
            add_header 'Access-Control-Allow-Origin' '*';
            add_header 'Cache-Control' 'no-cache, no-store';
        }
    }
}

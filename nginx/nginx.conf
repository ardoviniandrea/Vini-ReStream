events {}

http {
    # --- MODIFIED: Aggressive cache disabling ---
    sendfile off;
    sendfile_max_chunk 1k;
    open_file_cache off;
    expires -1;
    # --- END MODIFICATION ---

    # --- Map for Real Client IP ---
    map $http_x_real_ip $client_ip {
        default $http_x_real_ip;
        ""      $remote_addr;
    }

    # Define the upstream Node.js app (running on port 3000 inside the container)
    upstream node_app {
        server 127.0.0.1:3000;
    }

    # Custom log format
    log_format hls_log '$client_ip - [$time_local]';

    # Server 1: The UI Control Panel on port 8995
    server {
        listen 8995;

        location / {
            proxy_pass http://node_app;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
    }

    # Server 2: The HLS Stream on port 8994
    server {
        listen 8994;

        include /etc/nginx/blocklist.conf;

        # --- MODIFICATION: REMOVED the special 'location = /local_manifest.mpd' block ---
        # It was conflicting and unnecessary.

        # --- Specific rule for the HLS buffer directory ---
        location /buffer/ {
            root /var/www/hls;
            add_header 'Access-Control-Allow-Origin' '*';
            add_header 'Cache-Control' 'no-cache, no-store';
            types {
                video/mp2t ts;
            }
        }

        # Specific headers for the HLS playlist
        location = /live.m3u8 {
            root /var/www/hls;
            add_header 'Access-Control-Allow-Origin' '*';
            add_header 'Cache-Control' 'no-cache, no-store';
            types {
                application/vnd.apple.mpegurl m3u8;
            }
            access_log /var/log/nginx/hls_access.log hls_log;
        }
        
        # Specific headers for the HLS video segments
        location ~ \.ts$ {
            root /var/www/hls;
            add_header 'Access-Control-Allow-Origin' '*';
            add_header 'Cache-Control' 'no-cache, no-store';
            types {
                video/mp2t ts;
            }
            access_log /var/log/nginx/hls_access.log hls_log;
        }

        # --- MODIFIED: The fallback location ---
        # This block will now handle ALL other requests, including /local_manifest.mpd
        # We just need to add the MIME type for .mpd here.
        location / {
            root /var/www/hls;
            add_header 'Access-Control-Allow-Origin' '*';
            add_header 'Cache-Control' 'no-cache, no-store';
            
            # This 'types' block will now apply to all files served from here
            types {
                application/dash+xml mpd;
                application/vnd.apple.mpegurl m3u8;
                video/mp2t ts;
            }
        }
        # --- END MODIFICATION ---
    }
}


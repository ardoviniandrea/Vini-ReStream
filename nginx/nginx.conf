events {}

http {
# Define the upstream Node.js app (running on port 3000 inside the container)
upstream node_app {
server 127.0.0.1:3000;
}

# --- NEW ---
# Custom log format to capture just IP and timestamp
# Nginx time format: 18/Sep/2025:15:41:00 +0200
log_format hls_log '$remote_addr - [$time_local]';

# Server 1: The UI Control Panel on port 8995
server {
    listen 8995;

    # All requests to the UI port are proxied to the Node.js app
    location / {
        proxy_pass http://node_app;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}

# Server 2: The HLS Stream on port 8994
server {
    listen 8994;

    # --- NEW ---
    # Include the dynamic blocklist file.
    # The Node app will add 'deny 1.2.3.4;' lines to this file.
    include /etc/nginx/blocklist.conf;

    # All files are served directly from the shared HLS directory
    location / {
        root /var/www/hls;
        add_header 'Access-Control-Allow-Origin' '*';
        add_header 'Cache-Control' 'no-cache, no-store';
    }

    # Specific headers for the playlist
    location = /live.m3u8 {
        root /var/www/hls;
        add_header 'Access-Control-Allow-Origin' '*';
        add_header 'Cache-Control' 'no-cache, no-store';
        types {
            application/vnd.apple.mpegurl m3u8;
        }
        # --- NEW ---
        # Log playlist requests to our special log
        access_log /var/log/nginx/hls_access.log hls_log;
    }

    # Specific headers for the video segments
    location ~ \.ts$ {
        root /var/www/hls;
        add_header 'Access-Control-Allow-Origin' '*';
        add_header 'Cache-Control' 'no-cache, no-store';
        types {
            video/mp2t ts;
        }
        # --- NEW ---
        # Log segment requests to our special log
        access_log /var/log/nginx/hls_access.log hls_log;
    }
}

}

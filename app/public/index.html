<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vini ReStream Control</title>
    <link rel="icon" type="image/png" href="https://i.imgur.com/qqjoPdW.png">
    
    <!-- Using Tailwind CSS for a clean UI -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        html, body {
            height: 100%;
            font-family: 'Inter', sans-serif, system-ui;
        }
        /* Custom styles for the modal */
        #confirmation-modal {
            transition: opacity 0.2s ease-in-out;
        }
        #confirmation-modal.hidden {
            opacity: 0;
            pointer-events: none;
        }
        #confirmation-modal.visible {
            opacity: 1;
            pointer-events: auto;
        }
        /* Style for tables */
        .data-table th, .data-table td {
            padding: 0.75rem;
            border-bottom-width: 1px;
            border-color: #4b5563; /* gray-600 */
        }
        .data-table th {
            background-color: #374151; /* gray-700 */
            text-align: left;
            font-weight: 600;
        }
        .data-table td {
            background-color: #1f2937; /* gray-800 */
        }
        .data-table tr:last-child td {
            border-bottom: none;
        }

        /* --- NEW: Tab Styles --- */
        .tab-btn {
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            border: 2px solid transparent;
        }
        .tab-btn.active {
            background-color: #4f46e5; /* indigo-600 */
            color: white;
        }
        .tab-btn.inactive {
            background-color: #374151; /* gray-700 */
            color: #d1d5db; /* gray-300 */
            border-color: #4b5563; /* gray-600 */
        }
        .tab-btn.inactive:hover {
            background-color: #4b5563; /* gray-600 */
        }
        .tab-panel {
            display: none; /* Hidden by default */
        }
        .tab-panel.active {
            display: block; /* Shown when active */
        }

    </style>
</head>
<body class="bg-gray-900 text-white flex items-center justify-center min-h-screen p-4">

    <!-- 
      ================================================================
      --- NEW: AUTH CONTAINER (LOGIN / REGISTER) ---
      Visible by default, hidden after login
      ================================================================
    -->
    <div id="auth-container" class="bg-gray-800 p-8 rounded-2xl shadow-2xl w-full max-w-md">
        <!-- Header -->
        <div class="flex items-center justify-center mb-6 space-x-3">
            <img src="https://i.imgur.com/qqjoPdW.png" alt="Vini ReStream Logo" class="h-10 w-10 rounded-lg shadow-md" onerror="this.style.display='none'">
            <h1 class="text-3xl font-bold text-center text-indigo-400">Vini ReStream</h1>
        </div>
        
        <h2 id="auth-title" class="text-2xl font-bold text-center text-white mb-4">Login</h2>
        <p id="auth-subtitle" class="text-center text-gray-400 mb-6">Welcome back. Please log in to continue.</p>

        <!-- First-run setup message -->
        <div id="first-run-message" class="hidden bg-indigo-900/50 border border-indigo-500 text-indigo-200 p-3 rounded-lg text-sm text-center mb-4">
            No users found. Please create the first admin account to secure your server.
        </div>

        <!-- Login/Register Form -->
        <form id="auth-form">
            <div class="mb-4">
                <label for="username" class="block text-sm font-medium text-gray-300 mb-2">Username</label>
                <input type="text" id="username" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg text-white focus:ring-2 focus:ring-indigo-500 focus:outline-none" required>
            </div>
            <div class="mb-6">
                <label for="password" class="block text-sm font-medium text-gray-300 mb-2">Password</label>
                <input type="password" id="password" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg text-white focus:ring-2 focus:ring-indigo-500 focus:outline-none" required>
            </div>

            <!-- Auth Button (Login or Register) -->
            <button id="auth-btn" type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg transition duration-300 shadow-lg hover:shadow-indigo-500/50">
                Login
            </button>
        </form>

        <!-- Message Log for Auth -->
        <div id="auth-message-log" class="text-center text-red-400 mt-4 text-sm h-5"></div>
    </div>


    <!-- 
      ================================================================
      --- NEW: APP CONTAINER (STREAM + USER MGMT) ---
      Hidden by default, visible after login
      ================================================================
    -->
    <div id="app-container" class="bg-gray-800 p-8 rounded-2xl shadow-2xl w-full max-w-3xl" style="display: none;">
        
        <!-- App Header -->
        <div class="flex items-center justify-between mb-6 space-x-3">
            <div class="flex items-center space-x-3">
                <img src="https://i.imgur.com/qqjoPdW.png" alt="Vini ReStream Logo" class="h-10 w-10 rounded-lg shadow-md" onerror="this.style.display='none'">
                <h1 class="text-3xl font-bold text-indigo-400">Vini ReStream</h1>
            </div>
            <!-- NEW: Welcome & Logout -->
            <div class="text-right">
                <span class="text-sm text-gray-400 block">Welcome, <strong id="welcome-username" class="text-gray-200">User</strong></span>
                <button id="logout-btn" class="text-sm text-indigo-400 hover:text-indigo-300 hover:underline focus:outline-none">Logout</button>
            </div>
        </div>

        <!-- NEW: Tab Navigation -->
        <div class="flex space-x-2 mb-6 border-b border-gray-700 pb-3">
            <button id="tab-stream" class="tab-btn active" data-tab="stream-panel">Stream Control</button>
            <button id="tab-users" class="tab-btn inactive" data-tab="users-panel">User Management</button>
        </div>

        <!-- 
          ---------------------------------
          --- TAB 1: STREAM CONTROL (Original UI) ---
          ---------------------------------
        -->
        <div id="stream-panel" class="tab-panel active">
            <!-- Status Indicator -->
            <div class="mb-6 p-4 rounded-lg flex items-center justify-center border" id="status-indicator">
                <div class="h-4 w-4 rounded-full bg-red-500 mr-3" id="status-dot"></div>
                <span class="font-medium text-lg" id="status-text">Stream is OFFLINE</span>
            </div>

            <!-- URL Input -->
            <div class="mb-4">
                <label for="stream-url" class="block text-sm font-medium text-gray-300 mb-2">Authenticated Stream Link (40s expiry)</label>
                <input type="text" id="stream-url" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg text-white focus:ring-2 focus:ring-indigo-500 focus:outline-none" placeholder="Paste your .m3u8 or .mpd link here...">
            </div>

            <!-- Action Buttons -->
            <div class="flex space-x-4 mb-6">
                <button id="start-btn" class="flex-1 bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg transition duration-300 shadow-lg hover:shadow-indigo-500/50">
                    Start Stream
                </button>
                <button id="stop-btn" class="flex-1 bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-4 rounded-lg transition duration-300 shadow-lg hover:shadow-red-500/50">
                    Stop Stream
                </button>
            </div>

            <!-- Shareable Link -->
            <div class="bg-gray-900 p-4 rounded-lg" id="share-link-box" style="display: none;">
                <label class="block text-sm font-medium text-gray-400 mb-2">Shareable Stream Link (VLC, etc.)</Vlabel>
                <div class="flex">
                    <input type="text" id="share-link" class="w-full p-2 bg-gray-700 border border-gray-600 rounded-l-lg text-gray-200 focus:outline-none" readonly>
                    <button id="copy-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-r-lg">Copy</button>
                </div>
                <p id="copy-feedback" class="text-green-400 text-sm mt-2" style="display: none;">Copied to clipboard!</p>
            </div>

            <!-- Message Log -->
            <div id="message-log" class="text-center text-gray-400 mt-4 text-sm h-5"></div>

            <!-- Viewer List -->
            <div id="viewer-list-container" class="mt-8" style="display: none;">
                <h2 class="text-2xl font-bold mb-4 text-indigo-300">Active Viewers (<span id="viewer-count">0</span>)</h2>
                <div class="overflow-hidden rounded-lg shadow-md border border-gray-700">
                    <table id="viewer-table" class="data-table w-full">
                        <thead>
                            <tr>
                                <th class="p-3 text-left text-sm font-semibold text-gray-300 uppercase tracking-wider">IP Address</th>
                                <th class="p-3 text-left text-sm font-semibold text-gray-300 uppercase tracking-wider">First Seen</th>
                                <th class="p-3 text-left text-sm font-semibold text-gray-300 uppercase tracking-wider">Last Seen</th>
                                <th class="p-3 text-left text-sm font-semibold text-gray-300 uppercase tracking-wider">Action</th>
                            </tr>
                        </thead>
                        <tbody id="viewer-table-body" class="bg-gray-800 divide-y divide-gray-700">
                            <tr id="no-viewers-row">
                                <td colspan="4" class="p-4 text-center text-gray-400">No active viewers.</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div> <!-- End Stream Panel -->

        <!-- 
          ---------------------------------
          --- TAB 2: USER MANAGEMENT ---
          ---------------------------------
        -->
        <div id="users-panel" class="tab-panel">
            <h2 class="text-2xl font-bold mb-4 text-indigo-300">Manage Accounts</h2>
            
            <!-- Add New User Form -->
            <form id="add-user-form" class="mb-6 bg-gray-900 p-4 rounded-lg flex items-end space-x-3">
                <div class="flex-1">
                    <label for="new-username" class="block text-sm font-medium text-gray-300 mb-2">New Username</label>
                    <input type="text" id="new-username" class="w-full p-2 bg-gray-700 border border-gray-600 rounded-lg text-white focus:ring-2 focus:ring-indigo-500 focus:outline-none" required>
                </div>
                <div class="flex-1">
                    <label for="new-password" class="block text-sm font-medium text-gray-300 mb-2">New Password (min 4)</label>
                    <input type="password" id="new-password" class="w-full p-2 bg-gray-700 border border-gray-600 rounded-lg text-white focus:ring-2 focus:ring-indigo-500 focus:outline-none" required>
                </div>
                <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-3 rounded-lg transition h-10">Add User</button>
            </form>
            <div id="user-message-log" class="text-center text-gray-400 mb-4 text-sm h-5"></div>

            <!-- User List Table -->
            <div class="overflow-hidden rounded-lg shadow-md border border-gray-700">
                <table id="user-table" class="data-table w-full">
                    <thead>
                        <tr>
                            <th class="p-3 text-left text-sm font-semibold text-gray-300 uppercase tracking-wider">Username</th>
                            <th class="p-3 text-left text-sm font-semibold text-gray-300 uppercase tracking-wider">User ID</th>
                            <th class="p-3 text-left text-sm font-semibold text-gray-300 uppercase tracking-wider">Action</th>
                        </tr>
                    </thead>
                    <tbody id="user-table-body" class="bg-gray-800 divide-y divide-gray-700">
                        <tr id="no-users-row">
                            <td colspan="3" class="p-4 text-center text-gray-400">No other users found.</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div> <!-- End Users Panel -->

    </div> <!-- End App Container -->


    <!-- 
      ================================================================
      --- MODALS (Confirmation) ---
      ================================================================
    -->
    <div id="confirmation-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 hidden">
        <div class="bg-gray-800 rounded-lg shadow-2xl p-6 w-full max-w-sm">
            <h3 id="modal-title" class="text-xl font-bold mb-4">Confirm Action</h3>
            <p class="text-gray-300 mb-6" id="modal-message">Are you sure?</p>
            <div class="flex justify-end space-x-3">
                <button id="modal-cancel-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300">Cancel</button>
                <button id="modal-confirm-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300">Confirm</button>
            </div>
        </div>
    </div>


    <script>
        // API URL
        const apiUrl = '/api'; 

        // --- NEW: Global State ---
        let viewerCheckInterval = null;
        let authState = {
            isLoggedIn: false,
            hasUsers: false,
            username: ''
        };
        // This will hold the action to confirm (e.g., terminate IP, delete user)
        let pendingConfirmAction = null; 

        // --- NEW: Auth UI Elements ---
        const authContainer = document.getElementById('auth-container');
        const authForm = document.getElementById('auth-form');
        const authTitle = document.getElementById('auth-title');
        const authSubtitle = document.getElementById('auth-subtitle');
        const firstRunMessage = document.getElementById('first-run-message');
        const authBtn = document.getElementById('auth-btn');
        const authUsernameInput = document.getElementById('username');
        const authPasswordInput = document.getElementById('password');
        const authMessageLog = document.getElementById('auth-message-log');

        // --- NEW: App UI Elements ---
        const appContainer = document.getElementById('app-container');
        const welcomeUsername = document.getElementById('welcome-username');
        const logoutBtn = document.getElementById('logout-btn');

        // --- NEW: Tab UI Elements ---
        const tabStream = document.getElementById('tab-stream');
        const tabUsers = document.getElementById('tab-users');
        const streamPanel = document.getElementById('stream-panel');
        const usersPanel = document.getElementById('users-panel');

        // --- Stream Control UI Elements ---
        const streamUrlInput = document.getElementById('stream-url');
        const startBtn = document.getElementById('start-btn');
        const stopBtn = document.getElementById('stop-btn');
        const statusIndicator = document.getElementById('status-indicator');
        const statusDot = document.getElementById('status-dot');
        const statusText = document.getElementById('status-text');
        const shareLinkBox = document.getElementById('share-link-box');
        const shareLink = document.getElementById('share-link');
        const copyBtn = document.getElementById('copy-btn');
        const copyFeedback = document.getElementById('copy-feedback');
        const messageLog = document.getElementById('message-log');
        
        // --- Viewer List UI Elements ---
        const viewerListContainer = document.getElementById('viewer-list-container');
        const viewerCount = document.getElementById('viewer-count');
        const viewerTableBody = document.getElementById('viewer-table-body');
        const noViewersRow = document.getElementById('no-viewers-row');
        
        // --- NEW: User Management UI Elements ---
        const addUserForm = document.getElementById('add-user-form');
        const newUsernameInput = document.getElementById('new-username');
        const newPasswordInput = document.getElementById('new-password');
        const userTableBody = document.getElementById('user-table-body');
        const noUsersRow = document.getElementById('no-users-row');
        const userMessageLog = document.getElementById('user-message-log');

        // --- Modal UI Elements ---
        const modal = document.getElementById('confirmation-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalMessage = document.getElementById('modal-message');
        const modalCancelBtn = document.getElementById('modal-cancel-btn');
        const modalConfirmBtn = document.getElementById('modal-confirm-btn');


        // Set public stream URL
        const publicStreamUrl = `http://${window.location.hostname}:8994/live.m3u8`;
        shareLink.value = publicStreamUrl;

        // --- NEW: General Message Loggers ---
        function logAuthMessage(message, isError = true) {
            authMessageLog.textContent = message;
            authMessageLog.className = isError 
                ? 'text-center text-red-400 mt-4 text-sm h-5' 
                : 'text-center text-green-400 mt-4 text-sm h-5';
            setTimeout(() => { authMessageLog.textContent = ''; }, 4000);
        }

        function logStreamMessage(message, isError = false) {
            messageLog.textContent = message;
            messageLog.className = isError 
                ? 'text-center text-red-400 mt-4 text-sm h-5' 
                : 'text-center text-green-400 mt-4 text-sm h-5';
            setTimeout(() => { messageLog.textContent = ''; }, 4000);
        }

        function logUserMessage(message, isError = false) {
            userMessageLog.textContent = message;
            userMessageLog.className = isError 
                ? 'text-center text-red-400 mb-4 text-sm h-5' 
                : 'text-center text-green-400 mb-4 text-sm h-5';
            setTimeout(() => { userMessageLog.textContent = ''; }, 4000);
        }

        // --- NEW: UI State Management ---
        function showLoginPanel(hasUsers) {
            if (hasUsers) {
                // Normal login
                authTitle.textContent = 'Login';
                authSubtitle.textContent = 'Welcome back. Please log in to continue.';
                authBtn.textContent = 'Login';
                firstRunMessage.classList.add('hidden');
            } else {
                // First-run registration
                authTitle.textContent = 'Create Admin Account';
                authSubtitle.textContent = 'This will be the primary admin account.';
                authBtn.textContent = 'Register';
                firstRunMessage.classList.remove('hidden');
            }
            authContainer.style.display = 'block';
            appContainer.style.display = 'none';
        }

        function showAppPanel(username) {
            welcomeUsername.textContent = username;
            authContainer.style.display = 'none';
            appContainer.style.display = 'block';
            
            // On login, always default to stream tab and fetch status
            showTab('stream-panel');
            checkStatus(); 
            // Also pre-fetch the user list for the other tab
            fetchUsers();
        }

        function showTab(tabId) {
            if (tabId === 'stream-panel') {
                // Show stream panel
                streamPanel.classList.add('active');
                usersPanel.classList.remove('active');
                // Update tab buttons
                tabStream.classList.add('active');
                tabStream.classList.remove('inactive');
                tabUsers.classList.add('inactive');
                tabUsers.classList.remove('active');
            } else if (tabId === 'users-panel') {
                // Show users panel
                streamPanel.classList.remove('active');
                usersPanel.classList.add('active');
                // Update tab buttons
                tabStream.classList.add('inactive');
                tabStream.classList.remove('active');
                tabUsers.classList.add('active');
                tabUsers.classList.remove('inactive');
                // Fetch users every time tab is clicked
                fetchUsers();
            }
        }

        // --- NEW: Auth API Functions ---

        async function checkAuthStatus() {
            try {
                const response = await fetch(`${apiUrl}/auth/check`);
                const data = await response.json();
                
                authState.isLoggedIn = data.loggedIn;
                authState.hasUsers = data.hasUsers;
                authState.username = data.username || '';

                if (authState.isLoggedIn) {
                    showAppPanel(authState.username);
                } else {
                    showLoginPanel(authState.hasUsers);
                }
            } catch (error) {
                console.error('Failed to check auth status:', error);
                logAuthMessage('Cannot connect to server.');
                showLoginPanel(true); // Default to login if server check fails
            }
        }

        async function handleAuthFormSubmit(e) {
            e.preventDefault();
            const username = authUsernameInput.value;
            const password = authPasswordInput.value;

            if (!username || !password) {
                logAuthMessage('Username and password are required.');
                return;
            }

            let url;
            let action;

            if (authState.hasUsers) {
                // This is a LOGIN attempt
                url = `${apiUrl}/auth/login`;
                action = 'Logging in...';
            } else {
                // This is a REGISTER attempt
                if (password.length < 4) {
                    logAuthMessage('Password must be at least 4 characters long.');
                    return;
                }
                url = `${apiUrl}/auth/register`;
                action = 'Registering...';
            }
            authBtn.textContent = action;
            authBtn.disabled = true;

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });

                const data = await response.json();
                if (response.ok) {
                    // Success! Re-check auth status which will update the UI
                    await checkAuthStatus();
                } else {
                    // Show error from server
                    logAuthMessage(data.error || 'An unknown error occurred.');
                }
            } catch (error) {
                console.error('Auth error:', error);
                logAuthMessage('Failed to authenticate.');
            } finally {
                // Reset button text
                authBtn.textContent = authState.hasUsers ? 'Login' : 'Register';
                authBtn.disabled = false;
            }
        }

        async function handleLogout() {
            try {
                await fetch(`${apiUrl}/auth/logout`, { method: 'POST' });
            } catch (error) {
                console.error('Logout error:', error);
            } finally {
                // Always log out on client side, even if server fails
                authState.isLoggedIn = false;
                // Stop checking viewers
                stopViewerCheck();
                // Check auth status again (will show login panel)
                await checkAuthStatus();
            }
        }


        // --- NEW: User Management API Functions ---

        async function fetchUsers() {
            try {
                const response = await fetch(`${apiUrl}/users`);
                if (!response.ok) {
                    const data = await response.json();
                    throw new Error(data.error || 'Failed to fetch users');
                }
                const users = await response.json();
                
                userTableBody.innerHTML = ''; // Clear table
                if (users.length === 0) {
                    userTableBody.appendChild(noUsersRow);
                    return;
                }

                users.forEach(user => {
                    const row = document.createElement('tr');
                    row.className = "hover:bg-gray-700 transition-colors duration-150";
                    row.innerHTML = `
                        <td class="p-3 text-sm text-gray-200">${user.username}</td>
                        <td class="p-3 text-sm text-gray-400 font-mono">${user.id}</td>
                        <td class="p-3 text-sm">
                            <button class="delete-user-btn bg-red-600 hover:bg-red-700 text-white text-xs font-bold py-1 px-2 rounded-md shadow" data-id="${user.id}" data-username="${user.username}">
                                Delete
                            </button>
                        </td>
                    `;
                    userTableBody.appendChild(row);
                });

            } catch (error) {
                console.error('Error fetching users:', error);
                logUserMessage(error.message, true);
            }
        }

        async function handleAddUser(e) {
            e.preventDefault();
            const username = newUsernameInput.value;
            const password = newPasswordInput.value;

            if (!username || !password) {
                logUserMessage('Username and password are required', true);
                return;
            }
            if (password.length < 4) {
                logUserMessage('Password must be at least 4 chars', true);
                return;
            }

            try {
                // Register endpoint is re-used. Since we are logged in, it's an admin action.
                const response = await fetch(`${apiUrl}/auth/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                const data = await response.json();
                
                if (response.ok) {
                    logUserMessage(`User '${data.username}' created!`, false);
                    newUsernameInput.value = '';
                    newPasswordInput.value = '';
                    await fetchUsers(); // Refresh list
                } else {
                    logUserMessage(data.error || 'Failed to create user', true);
                }
            } catch (error) {
                console.error('Error adding user:', error);
                logUserMessage('Error adding user', true);
            }
        }

        async function handleDeleteUser(userId, username) {
            try {
                const response = await fetch(`${apiUrl}/users/${userId}`, {
                    method: 'DELETE'
                });
                const data = await response.json();
                if (response.ok) {
                    logUserMessage(`User '${username}' deleted.`, false);
                    await fetchUsers(); // Refresh list
                } else {
                    logUserMessage(data.error || 'Failed to delete user', true);
                }
            } catch (error) {
                console.error('Error deleting user:', error);
                logUserMessage('Error deleting user', true);
            }
        }


        // --- Stream Control API Functions (Originals, now using logStreamMessage) ---

        function updateStatus(running, url = "") {
            if (running) {
                statusIndicator.classList.remove('border-red-500');
                statusIndicator.classList.add('border-green-500');
                statusIndicator.style.borderColor = 'rgba(34, 197, 94, 0.5)';
                statusIndicator.style.background = 'rgba(34, 197, 94, 0.1)';
                statusDot.classList.remove('bg-red-500');
                statusDot.classList.add('bg-green-500');
                statusText.textContent = 'Stream is LIVE';
                shareLinkBox.style.display = 'block';
                streamUrlInput.value = url;
                
                viewerListContainer.style.display = 'block';
                startViewerCheck();
                fetchViewers();
            } else {
                statusIndicator.classList.remove('border-green-500');
                statusIndicator.classList.add('border-red-500');
                statusIndicator.style.borderColor = 'rgba(239, 68, 68, 0.5)';
                statusIndicator.style.background = 'rgba(239, 68, 68, 0.1)';
                statusDot.classList.remove('bg-green-500');
                statusDot.classList.add('bg-red-500');
                statusText.textContent = 'Stream is OFFLINE';
                shareLinkBox.style.display = 'none';
                
                viewerListContainer.style.display = 'none';
                stopViewerCheck();
                clearViewerTable();
            }
        }

        async function checkStatus() {
            if (!authState.isLoggedIn) return; // Don't check if not logged in
            try {
                const response = await fetch(`${apiUrl}/status`);
                if (response.status === 401) {
                    // Session expired!
                    logAuthMessage('Session expired. Please log in again.');
                    await handleLogout();
                    return;
                }
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                updateStatus(data.running, data.url);
            } catch (error) {
                console.error('Failed to check status:', error);
                logStreamMessage('Cannot connect to server', true);
                updateStatus(false);
            }
        }

        async function handleStartStream() {
            const url = streamUrlInput.value;
            if (!url) {
                logStreamMessage('Please paste the stream link first', true);
                return;
            }

            try {
                const response = await fetch(`${apiUrl}/start`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url })
                });
                const data = await response.json();
                if (response.ok) {
                    logStreamMessage('Stream started!', false);
                    updateStatus(true, url);
                } else {
                    logStreamMessage(data.error || 'Failed to start stream', true);
                }
            } catch (error) {
                console.error('Error starting stream:', error);
                logStreamMessage('Error starting stream', true);
            }
        }

        async function handleStopStream() {
            try {
                const response = await fetch(`${apiUrl}/stop`, { method: 'POST' });
                const data = await response.json();
                if (response.ok) {
                    logStreamMessage('Stream stopped', false);
                    updateStatus(false);
                    streamUrlInput.value = '';
                } else {
                    logStreamMessage(data.error || 'Failed to stop stream', true);
                }
            } catch (error) {
                console.error('Error stopping stream:', error);
                logStreamMessage('Error stopping stream', true);
            }
        }

        function handleCopy() {
            shareLink.select();
            try {
                document.execCommand('copy');
                copyFeedback.style.display = 'block';
                setTimeout(() => { copyFeedback.style.display = 'none'; }, 2000);
            } catch (err) {
                console.error('Failed to copy text: ', err);
                logStreamMessage('Failed to copy link', true);
            }
        }

        // --- Viewer List Functions (Originals) ---

        function formatTimeAgo(timestamp) {
            const now = Date.now();
            const seconds = Math.floor((now - timestamp) / 1000);
            if (seconds < 10) return "just now";
            if (seconds < 60) return `${seconds}s ago`;
            const minutes = Math.floor(seconds / 60);
            if (minutes < 60) return `${minutes}m ago`;
            const hours = Math.floor(minutes / 60);
            return `${hours}h ago`;
        }

        function clearViewerTable() {
            viewerTableBody.innerHTML = '';
            viewerTableBody.appendChild(noViewersRow);
            viewerCount.textContent = '0';
        }

        async function fetchViewers() {
            if (!authState.isLoggedIn) return; // Don't fetch if logged out
            try {
                const response = await fetch(`${apiUrl}/viewers`);
                if (response.status === 401) {
                    // Session expired!
                    logAuthMessage('Session expired. Please log in again.');
                    await handleLogout();
                    return;
                }
                if (!response.ok) {
                    throw new Error('Failed to fetch viewers');
                }
                const viewers = await response.json();
                viewerCount.textContent = viewers.length;
                viewerTableBody.innerHTML = '';

                if (viewers.length === 0) {
                    viewerTableBody.appendChild(noViewersRow);
                    return;
                }

                viewers.forEach(viewer => {
                    const row = document.createElement('tr');
                    row.className = "hover:bg-gray-700 transition-colors duration-150";
                    const isBlocked = viewer.isBlocked;
                    const buttonHtml = isBlocked
                        ? `<button class="bg-gray-500 text-gray-300 text-xs font-bold py-1 px-2 rounded-md cursor-not-allowed" disabled>Terminated</button>`
                        : `<button class="terminate-btn bg-red-600 hover:bg-red-700 text-white text-xs font-bold py-1 px-2 rounded-md shadow" data-ip="${viewer.ip}">Terminate</button>`;

                    row.innerHTML = `
                        <td class="p-3 text-sm text-gray-200 font-mono">${viewer.ip}</td>
                        <td class="p-3 text-sm text-gray-300">${formatTimeAgo(viewer.firstSeen)}</td>
                        <td class="p-3 text-sm text-green-400 font-medium">${formatTimeAgo(viewer.lastSeen)}</td>
                        <td class="p-3 text-sm">${buttonHtml}</td>
                    `;
                    viewerTableBody.appendChild(row);
                });

            } catch (error) {
                console.error('Error fetching viewers:', error);
                logStreamMessage('Could not update viewer list', true);
            }
        }

        function startViewerCheck() {
            if (viewerCheckInterval) return;
            viewerCheckInterval = setInterval(fetchViewers, 5000);
        }

        function stopViewerCheck() {
            if (viewerCheckInterval) {
                clearInterval(viewerCheckInterval);
                viewerCheckInterval = null;
            }
        }

        async function terminateIp(ip) {
             try {
                const response = await fetch(`${apiUrl}/terminate`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ip: ip })
                });
                const data = await response.json();
                if (response.ok) {
                    logStreamMessage(data.message || `Terminated ${ip}`, false);
                    fetchViewers();
                } else {
                    logStreamMessage(data.message || data.error || 'Failed to terminate', true);
                }
            } catch (error) {
                console.error('Error terminating IP:', error);
                logStreamMessage('Error terminating IP', true);
            }
        }

        // --- Modal Functions (NEW: Now generic) ---
        function showModal({ title, message, onConfirm }) {
            modalTitle.textContent = title;
            modalMessage.innerHTML = message; // Use innerHTML for strong tags
            pendingConfirmAction = onConfirm; // Store the confirm action
            
            modal.classList.remove('hidden');
            modal.classList.add('visible');
        }

        function hideModal() {
            pendingConfirmAction = null;
            modal.classList.add('hidden');
            modal.classList.remove('visible');
        }
        
        // --- Event Listeners ---

        // Auth
        authForm.addEventListener('submit', handleAuthFormSubmit);
        logoutBtn.addEventListener('click', handleLogout);
        
        // Tabs
        tabStream.addEventListener('click', () => showTab('stream-panel'));
        tabUsers.addEventListener('click', () => showTab('users-panel'));

        // Stream Control
        startBtn.addEventListener('click', handleStartStream);
        stopBtn.addEventListener('click', handleStopStream);
        copyBtn.addEventListener('click', handleCopy);

        // User Management
        addUserForm.addEventListener('submit', handleAddUser);
        userTableBody.addEventListener('click', (e) => {
            if (e.target && e.target.classList.contains('delete-user-btn')) {
                const id = e.target.getAttribute('data-id');
                const username = e.target.getAttribute('data-username');
                if (id && username) {
                    showModal({
                        title: 'Delete User',
                        message: `Are you sure you want to delete user <strong class="text-red-400">${username}</strong>? This is irreversible.`,
                        onConfirm: () => handleDeleteUser(id, username)
                    });
                }
            }
        });

        // Viewer List
        viewerTableBody.addEventListener('click', (e) => {
            if (e.target && e.target.classList.contains('terminate-btn')) {
                const ip = e.target.getAttribute('data-ip');
                if (ip) {
                    showModal({
                        title: 'Confirm Termination',
                        message: `Are you sure you want to terminate the stream for <strong class="text-red-400">${ip}</strong>? This is irreversible.`,
                        onConfirm: () => terminateIp(ip)
                    });
                }
            }
        });

        // Modal
        modalCancelBtn.addEventListener('click', hideModal);
        modalConfirmBtn.addEventListener('click', () => {
            if (pendingConfirmAction) {
                pendingConfirmAction();
            }
            hideModal();
        });

        // --- Initial Load ---
        // Check status on page load
        document.addEventListener('DOMContentLoaded', checkAuthStatus);
        
        // And check stream status every 10 seconds (if logged in)
        setInterval(checkStatus, 10000);
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Updated title and added favicon -->
    <title>Vini ReStream Control</title>
    <link rel="icon" type="image/png" href="https://i.imgur.com/qqjoPdW.png">
    
    <!-- Using Tailwind CSS for a clean UI -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        html, body {
            height: 100%;
            font-family: 'Inter', sans-serif, system-ui;
        }
        /* Custom styles for the modal */
        #confirmation-modal {
            transition: opacity 0.2s ease-in-out;
        }
        #confirmation-modal.hidden {
            opacity: 0;
            pointer-events: none;
        }
        #confirmation-modal.visible {
            opacity: 1;
            pointer-events: auto;
        }
        /* Style for table */
        #viewer-table th, #viewer-table td {
            padding: 0.75rem;
            border-bottom-width: 1px;
            border-color: #4b5563; /* gray-600 */
        }
        #viewer-table th {
            background-color: #374151; /* gray-700 */
            text-align: left;
            font-weight: 600;
        }
        #viewer-table td {
            background-color: #1f2937; /* gray-800 */
        }
        #viewer-table tr:last-child td {
            border-bottom: none;
        }
    </style>
</head>
<body class="bg-gray-900 text-white flex items-center justify-center min-h-screen p-4">
    <!-- Changed max-w-lg to max-w-3xl to make space for the table -->
    <div class="bg-gray-800 p-8 rounded-2xl shadow-2xl w-full max-w-3xl">
        
        <!-- New Header with Logo and Title -->
        <div class="flex items-center justify-center mb-6 space-x-3">
            <img src="https://i.imgur.com/qqjoPdW.png" alt="Vini ReStream Logo" class="h-10 w-10 rounded-lg shadow-md" onerror="this.style.display='none'">
            <h1 class="text-3xl font-bold text-center text-indigo-400">Vini ReStream</h1>
        </div>

        <!-- Status Indicator -->
        <div class="mb-6 p-4 rounded-lg flex items-center justify-center border" id="status-indicator">
            <div class="h-4 w-4 rounded-full bg-red-500 mr-3" id="status-dot"></div>
            <span class="font-medium text-lg" id="status-text">Stream is OFFLINE</span>
        </div>

        <!-- URL Input -->
        <div class="mb-4">
            <label for="stream-url" class="block text-sm font-medium text-gray-300 mb-2">Authenticated Stream Link (40s expiry)</label>
            <input type="text" id="stream-url" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg text-white focus:ring-2 focus:ring-indigo-500 focus:outline-none" placeholder="Paste your .m3u8 or .mpd link here...">
        </div>

        <!-- Action Buttons -->
        <div class="flex space-x-4 mb-6">
            <button id="start-btn" class="flex-1 bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg transition duration-300 shadow-lg hover:shadow-indigo-500/50">
                Start Stream
            </button>
            <button id="stop-btn" class="flex-1 bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-4 rounded-lg transition duration-300 shadow-lg hover:shadow-red-500/50">
                Stop Stream
            </button>
        </div>

        <!-- Shareable Link -->
        <div class="bg-gray-900 p-4 rounded-lg" id="share-link-box" style="display: none;">
            <label class="block text-sm font-medium text-gray-400 mb-2">Shareable Stream Link (VLC, etc.)</Vlabel>
            <div class="flex">
                <input type="text" id="share-link" class="w-full p-2 bg-gray-700 border border-gray-600 rounded-l-lg text-gray-200 focus:outline-none" readonly>
                <button id="copy-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-r-lg">Copy</button>
            </div>
            <p id="copy-feedback" class="text-green-400 text-sm mt-2" style="display: none;">Copied to clipboard!</p>
        </div>

        <!-- Message Log -->
        <div id="message-log" class="text-center text-gray-400 mt-4 text-sm h-5"></div>

        <!-- NEW: Viewer List -->
        <div id="viewer-list-container" class="mt-8" style="display: none;">
            <h2 class="text-2xl font-bold mb-4 text-indigo-300">Active Viewers (<span id="viewer-count">0</span>)</h2>
            <div class="overflow-hidden rounded-lg shadow-md border border-gray-700">
                <table id="viewer-table" class="w-full">
                    <thead class="bg-gray-700">
                        <tr>
                            <th class="p-3 text-left text-sm font-semibold text-gray-300 uppercase tracking-wider">IP Address</th>
                            <th class="p-3 text-left text-sm font-semibold text-gray-300 uppercase tracking-wider">First Seen</th>
                            <th class="p-3 text-left text-sm font-semibold text-gray-300 uppercase tracking-wider">Last Seen</th>
                            <th class="p-3 text-left text-sm font-semibold text-gray-300 uppercase tracking-wider">Action</th>
                        </tr>
                    </thead>
                    <tbody id="viewer-table-body" class="bg-gray-800 divide-y divide-gray-700">
                        <!-- Rows will be injected here -->
                        <tr id="no-viewers-row">
                            <td colspan="4" class="p-4 text-center text-gray-400">No active viewers.</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- NEW: Confirmation Modal -->
    <div id="confirmation-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 hidden">
        <div class="bg-gray-800 rounded-lg shadow-2xl p-6 w-full max-w-sm">
            <h3 class="text-xl font-bold mb-4">Confirm Termination</h3>
            <p class="text-gray-300 mb-6">Are you sure you want to terminate the stream for <strong id="modal-ip-address" class="text-red-400"></strong>? This action is irreversible.</p>
            <div class="flex justify-end space-x-3">
                <button id="modal-cancel-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300">Cancel</button>
                <button id="modal-confirm-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300">Terminate</button>
            </div>
        </div>
    </div>


    <script>
        // The API is on the same host, served from the root
        const apiUrl = '/api'; 
        const streamUrlInput = document.getElementById('stream-url');
        const startBtn = document.getElementById('start-btn');
        const stopBtn = document.getElementById('stop-btn');
        
        // Status UI
        const statusIndicator = document.getElementById('status-indicator');
        const statusDot = document.getElementById('status-dot');
        const statusText = document.getElementById('status-text');
        
        // Share Link UI
        const shareLinkBox = document.getElementById('share-link-box');
        const shareLink = document.getElementById('share-link');
        const copyBtn = document.getElementById('copy-btn');
        const copyFeedback = document.getElementById('copy-feedback');

        // Message Log
        const messageLog = document.getElementById('message-log');

        // --- NEW: Viewer List UI ---
        const viewerListContainer = document.getElementById('viewer-list-container');
        const viewerCount = document.getElementById('viewer-count');
        const viewerTableBody = document.getElementById('viewer-table-body');
        const noViewersRow = document.getElementById('no-viewers-row');
        let viewerCheckInterval = null;

        // --- NEW: Modal UI ---
        const modal = document.getElementById('confirmation-modal');
        const modalIp = document.getElementById('modal-ip-address');
        const modalCancelBtn = document.getElementById('modal-cancel-btn');
        const modalConfirmBtn = document.getElementById('modal-confirm-btn');
        let ipToTerminate = null;


        // Updated to use the new stream port 8994
        const publicStreamUrl = `http://${window.location.hostname}:8994/live.m3u8`;
        shareLink.value = publicStreamUrl;

        function logMessage(message, isError = false) {
            messageLog.textContent = message;
            messageLog.className = isError 
                ? 'text-center text-red-400 mt-4 text-sm h-5' 
                : 'text-center text-green-400 mt-4 text-sm h-5';
            
            setTimeout(() => { messageLog.textContent = ''; }, 4000);
        }

        function updateStatus(running, url = "") {
            if (running) {
                statusIndicator.classList.remove('border-red-500');
                statusIndicator.classList.add('border-green-500');
                statusIndicator.style.borderColor = 'rgba(34, 197, 94, 0.5)';
                statusIndicator.style.background = 'rgba(34, 197, 94, 0.1)';
                statusDot.classList.remove('bg-red-500');
                statusDot.classList.add('bg-green-500');
                statusText.textContent = 'Stream is LIVE';
                shareLinkBox.style.display = 'block';
                streamUrlInput.value = url; // Show the currently streaming URL
                
                // --- NEW ---
                viewerListContainer.style.display = 'block';
                startViewerCheck();
                fetchViewers(); // Fetch immediately
            } else {
                statusIndicator.classList.remove('border-green-500');
                statusIndicator.classList.add('border-red-500');
                statusIndicator.style.borderColor = 'rgba(239, 68, 68, 0.5)';
                statusIndicator.style.background = 'rgba(239, 68, 68, 0.1)';
                statusDot.classList.remove('bg-green-500');
                statusDot.classList.add('bg-red-500');
                statusText.textContent = 'Stream is OFFLINE';
                shareLinkBox.style.display = 'none';
                
                // --- NEW ---
                viewerListContainer.style.display = 'none';
                stopViewerCheck();
                clearViewerTable();
            }
        }

        async function checkStatus() {
            try {
                const response = await fetch(`${apiUrl}/status`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                updateStatus(data.running, data.url);
            } catch (error) {
                console.error('Failed to check status:', error);
                logMessage('Cannot connect to server', true);
                updateStatus(false); // Set to offline if status check fails
            }
        }

        startBtn.addEventListener('click', async () => {
            const url = streamUrlInput.value;
            if (!url) {
                logMessage('Please paste the stream link first', true);
                return;
            }

            try {
                const response = await fetch(`${apiUrl}/start`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url })
                });
                const data = await response.json();
                if (response.ok) {
                    logMessage('Stream started!');
                    updateStatus(true, url);
                } else {
                    logMessage(data.error || 'Failed to start stream', true);
                }
            } catch (error) {
                console.error('Error starting stream:', error);
                logMessage('Error starting stream', true);
            }
        });

        stopBtn.addEventListener('click', async () => {
            try {
                const response = await fetch(`${apiUrl}/stop`, { method: 'POST' });
                const data = await response.json();
                if (response.ok) {
                    logMessage('Stream stopped');
                    updateStatus(false);
                    streamUrlInput.value = ''; // Clear input after stopping
                } else {
                    logMessage(data.error || 'Failed to stop stream', true);
                }
            } catch (error) {
                console.error('Error stopping stream:', error);
                logMessage('Error stopping stream', true);
            }
        });

        copyBtn.addEventListener('click', () => {
            shareLink.select();
            // Use execCommand for iframe compatibility
            try {
                document.execCommand('copy');
                copyFeedback.style.display = 'block';
                setTimeout(() => { copyFeedback.style.display = 'none'; }, 2000);
            } catch (err) {
                console.error('Failed to copy text: ', err);
                logMessage('Failed to copy link', true);
            }
        });

        // --- NEW: Viewer List Functions ---

        function formatTimeAgo(timestamp) {
            const now = Date.now();
            const seconds = Math.floor((now - timestamp) / 1000);
            if (seconds < 10) return "just now";
            if (seconds < 60) return `${seconds}s ago`;
            const minutes = Math.floor(seconds / 60);
            if (minutes < 60) return `${minutes}m ago`;
            const hours = Math.floor(minutes / 60);
            return `${hours}h ago`;
        }

        function clearViewerTable() {
            viewerTableBody.innerHTML = ''; // Clear all rows
            viewerTableBody.appendChild(noViewersRow); // Add back the 'no viewers' row
            viewerCount.textContent = '0';
        }

        async function fetchViewers() {
            try {
                const response = await fetch(`${apiUrl}/viewers`);
                if (!response.ok) {
                    throw new Error('Failed to fetch viewers');
                }
                const viewers = await response.json();
                viewerCount.textContent = viewers.length;
                viewerTableBody.innerHTML = ''; // Clear existing rows

                if (viewers.length === 0) {
                    viewerTableBody.appendChild(noViewersRow);
                    return;
                }

                viewers.forEach(viewer => {
                    const row = document.createElement('tr');
                    row.className = "hover:bg-gray-700 transition-colors duration-150";

                    // --- MODIFIED: Button logic ---
                    const isBlocked = viewer.isBlocked;
                    const buttonHtml = isBlocked
                        ? `<button class="bg-gray-500 text-gray-300 text-xs font-bold py-1 px-2 rounded-md cursor-not-allowed" disabled>
                               Terminated
                           </button>`
                        : `<button class="terminate-btn bg-red-600 hover:bg-red-700 text-white text-xs font-bold py-1 px-2 rounded-md shadow" data-ip="${viewer.ip}">
                               Terminate
                           </button>`;

                    row.innerHTML = `
                        <td class="p-3 text-sm text-gray-200 font-mono">${viewer.ip}</td>
                        <td class="p-3 text-sm text-gray-300">${formatTimeAgo(viewer.firstSeen)}</td>
                        <td class="p-3 text-sm text-green-400 font-medium">${formatTimeAgo(viewer.lastSeen)}</td>
                        <td class="p-3 text-sm">
                            ${buttonHtml}
                        </td>
                    `;
                    viewerTableBody.appendChild(row);
                });

            } catch (error) {
                console.error('Error fetching viewers:', error);
                logMessage('Could not update viewer list', true);
            }
        }

        function startViewerCheck() {
            if (viewerCheckInterval) return; // Already running
            viewerCheckInterval = setInterval(fetchViewers, 5000); // Check every 5 seconds
        }

        function stopViewerCheck() {
            if (viewerCheckInterval) {
                clearInterval(viewerCheckInterval);
                viewerCheckInterval = null;
            }
        }

        // --- NEW: Modal Functions ---
        function showModal(ip) {
            ipToTerminate = ip;
            modalIp.textContent = ip;
            modal.classList.remove('hidden');
            modal.classList.add('visible');
        }

        function hideModal() {
            ipToTerminate = null;
            modal.classList.add('hidden');
            modal.classList.remove('visible');
        }

        modalCancelBtn.addEventListener('click', hideModal);

        modalConfirmBtn.addEventListener('click', async () => {
            if (!ipToTerminate) return;

            try {
                const response = await fetch(`${apiUrl}/terminate`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ip: ipToTerminate })
                });
                const data = await response.json();

                if (response.ok) {
                    logMessage(data.message || `Terminated ${ipToTerminate}`);
                    fetchViewers(); // Refresh the list immediately
                } else {
                    // Log the 409 error message from the server
                    logMessage(data.message || data.error || 'Failed to terminate', true);
                }
            } catch (error) {
                console.error('Error terminating IP:', error);
                logMessage('Error terminating IP', true);
            } finally {
                hideModal();
            }
        });

        // Add event listener to table body for terminate buttons (event delegation)
        viewerTableBody.addEventListener('click', (e) => {
            if (e.target && e.target.classList.contains('terminate-btn')) {
                const ip = e.target.getAttribute('data-ip');
                if (ip) {
                    showModal(ip);
                }
            }
        });

        // Check status on page load
        checkStatus();
        // And check every 10 seconds
        setInterval(checkStatus, 10000);
    </script>
</body>
</html>


<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vini ReStream Control</title>
    <link rel="icon" type="image/png" href="https://i.imgur.com/qqjoPdW.png">
    
    <!-- Using Tailwind CSS for a clean UI -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        html, body {
            height: 100%;
            font-family: 'Inter', sans-serif, system-ui;
        }
        /* Custom styles for modals */
        .modal-backdrop {
            transition: opacity 0.2s ease-in-out;
        }
        .modal-backdrop.hidden {
            opacity: 0;
            pointer-events: none;
        }
        .modal-backdrop.visible {
            opacity: 1;
            pointer-events: auto;
        }
        .modal-content {
            transition: all 0.2s ease-in-out;
            transform: scale(0.95);
            opacity: 0;
        }
        .modal-backdrop.visible .modal-content {
            transform: scale(1);
            opacity: 1;
        }
        /* Style for tables */
        .data-table th, .data-table td {
            padding: 0.75rem;
            border-bottom-width: 1px;
            border-color: #4b5563; /* gray-600 */
        }
        .data-table th {
            background-color: #374151; /* gray-700 */
            text-align: left;
            font-weight: 600;
        }
        .data-table td {
            background-color: #1f2937; /* gray-800 */
        }
        .data-table tr:last-child td {
            border-bottom: none;
        }

        /* --- Tab Styles --- */
        .tab-btn {
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            border: 2px solid transparent;
        }
        .tab-btn.active {
            background-color: #4f46e5; /* indigo-600 */
            color: white;
        }
        .tab-btn.inactive {
            background-color: #374151; /* gray-700 */
            color: #d1d5db; /* gray-300 */
            border-color: #4b5563; /* gray-600 */
        }
        .tab-btn.inactive:hover {
            background-color: #4b5563; /* gray-600 */
        }
        .tab-panel {
            display: none; /* Hidden by default */
        }
        .tab-panel.active {
            display: block; /* Shown when active */
        }

        /* Custom Switch */
        .switch { position: relative; display: inline-block; width: 38px; height: 22px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #4b5563; transition: .4s; border-radius: 22px; }
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #4f46e5; }
        input:focus + .slider { box-shadow: 0 0 1px #4f46e5; }
        input:checked + .slider:before { transform: translateX(16px); }

        /* Disable buttons for default profiles */
        button:disabled {
            cursor: not-allowed;
            opacity: 0.5;
        }
    </style>
</head>
<body class="bg-gray-900 text-white flex items-center justify-center min-h-screen p-4">

    <!-- 
      ================================================================
      --- AUTH CONTAINER (LOGIN / REGISTER) ---
      Visible by default, hidden after login
      ================================================================
    -->
    <div id="auth-container" class="bg-gray-800 p-8 rounded-2xl shadow-2xl w-full max-w-md" style="display: none;">
        <!-- Header -->
        <div class="flex items-center justify-center mb-6 space-x-3">
            <img src="https://i.imgur.com/qqjoPdW.png" alt="Vini ReStream Logo" class="h-10 w-10 rounded-lg shadow-md" onerror="this.style.display='none'">
            <h1 class="text-3xl font-bold text-center text-indigo-400">Vini ReStream</h1>
        </div>
        
        <h2 id="auth-title" class="text-2xl font-bold text-center text-white mb-4">Login</h2>
        <p id="auth-subtitle" class="text-center text-gray-400 mb-6">Welcome back. Please log in to continue.</p>

        <!-- First-run setup message -->
        <div id="first-run-message" class="hidden bg-indigo-900/50 border border-indigo-500 text-indigo-200 p-3 rounded-lg text-sm text-center mb-4">
            No users found. Please create the first admin account to secure your server.
        </div>

        <!-- Login/Register Form -->
        <form id="auth-form">
            <div class="mb-4">
                <label for="username" class="block text-sm font-medium text-gray-300 mb-2">Username</label>
                <input type="text" id="username" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg text-white focus:ring-2 focus:ring-indigo-500 focus:outline-none" required>
            </div>
            <div class="mb-6">
                <label for="password" class="block text-sm font-medium text-gray-300 mb-2">Password</label>
                <input type="password" id="password" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg text-white focus:ring-2 focus:ring-indigo-500 focus:outline-none" required>
            </div>

            <!-- Auth Button (Login or Register) -->
            <button id="auth-btn" type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg transition duration-300 shadow-lg hover:shadow-indigo-500/50">
                Login
            </button>
        </form>

        <!-- Message Log for Auth -->
        <div id="auth-message-log" class="text-center text-red-400 mt-4 text-sm h-5"></div>
    </div>


    <!-- 
      ================================================================
      --- APP CONTAINER (STREAM + USER MGMT + SETTINGS) ---
      Hidden by default, visible after login
      ================================================================
    -->
    <div id="app-container" class="bg-gray-800 p-8 rounded-2xl shadow-2xl w-full max-w-4xl" style="display: none;">
        
        <!-- App Header -->
        <div class="flex items-center justify-between mb-6 space-x-3">
            <div class="flex items-center space-x-3">
                <img src="https://i.imgur.com/qqjoPdW.png" alt="Vini ReStream Logo" class="h-10 w-10 rounded-lg shadow-md" onerror="this.style.display='none'">
                <h1 class="text-3xl font-bold text-indigo-400">Vini ReStream</h1>
            </div>
            <!-- Welcome & Logout -->
            <div class="text-right">
                <span class="text-sm text-gray-400 block">Welcome, <strong id="welcome-username" class="text-gray-200">User</strong></span>
                <button id="logout-btn" class="text-sm text-indigo-400 hover:text-indigo-300 hover:underline focus:outline-none">Logout</button>
            </div>
        </div>

        <!-- Tab Navigation -->
        <div class="flex space-x-2 mb-6 border-b border-gray-700 pb-3">
            <button id="tab-stream" class="tab-btn active" data-tab="stream-panel">Stream Control</button>
            <button id="tab-users" class="tab-btn inactive" data-tab="users-panel">User Management</button>
            <button id="tab-settings" class="tab-btn inactive" data-tab="settings-panel">Settings</button>
        </div>

        <!-- 
          ---------------------------------
          --- TAB 1: STREAM CONTROL ---
          ---------------------------------
        -->
        <div id="stream-panel" class="tab-panel active">
            <!-- Status Indicator -->
            <div class="mb-6 p-4 rounded-lg flex items-center justify-center border" id="status-indicator">
                <div class="h-4 w-4 rounded-full bg-red-500 mr-3" id="status-dot"></div>
                <span class="font-medium text-lg" id="status-text">Stream is OFFLINE</span>
            </div>

            <!-- URL Input -->
            <div class="mb-4">
                <label for="stream-url" class="block text-sm font-medium text-gray-300 mb-2">Authenticated Stream Link</label>
                <input type="text" id="stream-url" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg text-white focus:ring-2 focus:ring-indigo-500 focus:outline-none" placeholder="Paste your .m3u8 link here...">
            </div>

            <!-- Action Buttons -->
            <div class="flex space-x-4 mb-6">
                <button id="start-btn" class="flex-1 bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg transition duration-300 shadow-lg hover:shadow-indigo-500/50">
                    Start Stream
                </button>
                <button id="stop-btn" class="flex-1 bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-4 rounded-lg transition duration-300 shadow-lg hover:shadow-red-500/50">
                    Stop Stream
                </button>
            </div>

            <!-- Shareable Link -->
            <div class="bg-gray-900 p-4 rounded-lg" id="share-link-box" style="display: none;">
                <label class="block text-sm font-medium text-gray-400 mb-2">Shareable Stream Link (VLC, etc.)</Vlabel>
                <div class="flex">
                    <input type="text" id="share-link" class="w-full p-2 bg-gray-700 border border-gray-600 rounded-l-lg text-gray-200 focus:outline-none" readonly>
                    <button id="copy-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-r-lg">Copy</button>
                </div>
                <p id="copy-feedback" class="text-green-400 text-sm mt-2" style="display: none;">Copied to clipboard!</p>
            </div>

            <!-- Message Log -->
            <div id="message-log" class="text-center text-gray-400 mt-4 text-sm h-5"></div>

            <!-- Viewer List -->
            <div id="viewer-list-container" class="mt-8" style="display: none;">
                <h2 class="text-2xl font-bold mb-4 text-indigo-300">Active Viewers (<span id="viewer-count">0</span>)</h2>
                <div class="overflow-hidden rounded-lg shadow-md border border-gray-700">
                    <table id="viewer-table" class="data-table w-full">
                        <thead>
                            <tr>
                                <th class="p-3 text-left text-sm font-semibold text-gray-300 uppercase tracking-wider">IP Address</th>
                                <th class="p-3 text-left text-sm font-semibold text-gray-300 uppercase tracking-wider">First Seen</th>
                                <th class="p-3 text-left text-sm font-semibold text-gray-300 uppercase tracking-wider">Last Seen</th>
                                <th class="p-3 text-left text-sm font-semibold text-gray-300 uppercase tracking-wider">Action</th>
                            </tr>
                        </thead>
                        <tbody id="viewer-table-body" class="bg-gray-800 divide-y divide-gray-700">
                            <tr id="no-viewers-row">
                                <td colspan="4" class="p-4 text-center text-gray-400">No active viewers.</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div> <!-- End Stream Panel -->

        <!-- 
          ---------------------------------
          --- TAB 2: USER MANAGEMENT ---
          ---------------------------------
        -->
        <div id="users-panel" class="tab-panel">
            <h2 class="text-2xl font-bold mb-4 text-indigo-300">Manage Accounts</h2>
            
            <!-- Add New User Form -->
            <form id="add-user-form" class="mb-6 bg-gray-900 p-4 rounded-lg flex items-end space-x-3">
                <div class="flex-1">
                    <label for="new-username" class="block text-sm font-medium text-gray-300 mb-2">New Username</label>
                    <input type="text" id="new-username" class="w-full p-2 bg-gray-700 border border-gray-600 rounded-lg text-white focus:ring-2 focus:ring-indigo-500 focus:outline-none" required>
                </div>
                <div class="flex-1">
                    <label for="new-password" class="block text-sm font-medium text-gray-300 mb-2">New Password (min 4)</label>
                    <input type="password" id="new-password" class="w-full p-2 bg-gray-700 border border-gray-600 rounded-lg text-white focus:ring-2 focus:ring-indigo-500 focus:outline-none" required>
                </div>
                <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-3 rounded-lg transition h-10">Add User</button>
            </form>
            <div id="user-message-log" class="text-center text-gray-400 mb-4 text-sm h-5"></div>

            <!-- User List Table -->
            <div class="overflow-hidden rounded-lg shadow-md border border-gray-700">
                <table id="user-table" class="data-table w-full">
                    <thead>
                        <tr>
                            <th class="p-3 text-left text-sm font-semibold text-gray-300 uppercase tracking-wider">Username</th>
                            <th class="p-3 text-left text-sm font-semibold text-gray-300 uppercase tracking-wider">User ID</th>
                            <th class="p-3 text-left text-sm font-semibold text-gray-300 uppercase tracking-wider">Action</th>
                        </tr>
                    </thead>
                    <tbody id="user-table-body" class="bg-gray-800 divide-y divide-gray-700">
                        <tr id="no-users-row">
                            <td colspan="3" class="p-4 text-center text-gray-400">No other users found.</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div> <!-- End Users Panel -->

        <!-- 
          ---------------------------------
          --- TAB 3: SETTINGS (NEW) ---
          ---------------------------------
        -->
        <div id="settings-panel" class="tab-panel space-y-6">
            
            <!-- Idea 1: Pre-fetch Buffer Settings -->
            <div class="bg-gray-900 p-6 rounded-lg border border-gray-700">
                <h3 class="text-xl font-bold text-indigo-300 mb-2">Pre-fetch Buffer (Idea 1)</h3>
                <p class="text-sm text-gray-400 mb-4">Enable this to download stream segments in advance. This creates a delay but massively improves stability on flaky source streams and prevents skips on mobile.</p>
                <div class="space-y-4">
                    <div class="flex items-center justify-between">
                        <label for="buffer-enabled" class="font-medium text-gray-200">Enable Pre-fetch Buffer</label>
                        <label class="switch">
                            <input type="checkbox" id="buffer-enabled">
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div class="flex items-center justify-between">
                        <label for="buffer-delay" class="font-medium text-gray-200">Buffer Delay (seconds)</label>
                        <input type="number" id="buffer-delay" value="30" min="5" max="300" class="w-24 p-2 bg-gray-700 border border-gray-600 rounded-lg text-white focus:ring-2 focus:ring-indigo-500 focus:outline-none">
                    </div>
                </div>
            </div>

            <!-- Idea 2: FFmpeg Profile Manager -->
            <div class="bg-gray-900 p-6 rounded-lg border border-gray-700">
                <h3 class="text-xl font-bold text-indigo-300 mb-2">FFmpeg Profile Manager (Idea 2)</h3>
                <p class="text-sm text-gray-400 mb-4">Select the FFmpeg command to use for transcoding. Add custom profiles to use hardware acceleration (e.g., NVIDIA NVENC).</p>
                
                <div class="mb-4">
                    <label for="active-profile-select" class="block text-sm font-medium text-gray-300 mb-2">Active Stream Profile</label>
                    <select id="active-profile-select" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg text-white focus:ring-2 focus:ring-indigo-500 focus:outline-none"></select>
                </div>
                
                <div class="flex space-x-3">
                    <button id="add-profile-btn" class="flex-1 bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition">New Profile</button>
                    <button id="edit-profile-btn" class="flex-1 bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg transition">Edit Selected</button>
                    <button id="delete-profile-btn" class="flex-1 bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition">Delete Selected</button>
                </div>
            </div>

            <!-- Save Button for all settings -->
            <div class="mt-6 flex justify-end">
                 <button id="save-settings-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-lg transition duration-300 shadow-lg hover:shadow-indigo-500/50">
                    Save All Settings
                </button>
            </div>
            <div id="settings-message-log" class="text-center text-gray-400 mt-4 text-sm h-5"></div>
        </div><!-- End Settings Panel -->


    </div> <!-- End App Container -->


    <!-- 
      ================================================================
      --- MODALS ---
      ================================================================
    -->
    
    <!-- Confirmation Modal (Generic) -->
    <div id="confirmation-modal" class="modal-backdrop fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 hidden z-50">
        <div class="modal-content bg-gray-800 rounded-lg shadow-2xl p-6 w-full max-w-sm">
            <h3 id="modal-title" class="text-xl font-bold mb-4">Confirm Action</h3>
            <p class="text-gray-300 mb-6" id="modal-message">Are you sure?</p>
            <div class="flex justify-end space-x-3">
                <button id="modal-cancel-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300">Cancel</button>
                <button id="modal-confirm-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300">Confirm</button>
            </div>
        </div>
    </div>

    <!-- NEW: Profile Editor Modal -->
    <div id="profile-editor-modal" class="modal-backdrop hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50">
        <div class="modal-content bg-gray-800 rounded-lg shadow-2xl w-full max-w-2xl">
            <form id="profile-editor-form">
                <div class="p-6">
                    <h3 id="profile-modal-title" class="text-xl font-bold text-white mb-4"></h3>
                    <input type="hidden" id="profile-id">
                    <input type="hidden" id="profile-is-default" value="false">
                    
                    <div class="space-y-4">
                        <div>
                            <label for="profile-name" class="block text-sm font-medium text-gray-400">Profile Name</label>
                            <input type="text" id="profile-name" class="mt-1 block w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-white focus:ring-blue-500 focus:border-blue-500" required>
                        </div>
                        <div>
                            <label for="profile-command" class="block text-sm font-medium text-gray-400">FFmpeg Command</label>
                            <textarea id="profile-command" rows="6" class="mt-1 block w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-white font-mono text-sm focus:ring-blue-500 focus:border-blue-500" required></textarea>
                            <p class="text-xs text-gray-500 mt-2">
                                Use placeholders:
                                <code class="bg-gray-900 text-indigo-300 px-1 py-0.5 rounded">{streamUrl}</code>
                                <code class="bg-gray-900 text-indigo-300 px-1 py-0.5 rounded">{userAgent}</code>
                            </p>
                        </div>
                    </div>
                </div>
                <div class="bg-gray-700/50 px-6 py-4 flex justify-end gap-4 rounded-b-lg">
                    <button type="button" id="modal-cancel-profile-btn" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-md">Cancel</button>
                    <button type="submit" id="modal-save-profile-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md">Save Profile</button>
                </div>
            </form>
        </div>
    </div>


    <script>
        // API URL
        const apiUrl = '/api'; 

        // --- Global State ---
        let viewerCheckInterval = null;
        let authState = {
            isLoggedIn: false,
            hasUsers: false,
            username: ''
        };
        let pendingConfirmAction = null; 
        // NEW: Global settings cache
        let globalSettings = {
            buffer: {
                enabled: false,
                delaySeconds: 30
            },
            profiles: [],
            activeProfileId: null
        };

        // --- Auth UI Elements ---
        const authContainer = document.getElementById('auth-container');
        const authForm = document.getElementById('auth-form');
        const authTitle = document.getElementById('auth-title');
        const authSubtitle = document.getElementById('auth-subtitle');
        const firstRunMessage = document.getElementById('first-run-message');
        const authBtn = document.getElementById('auth-btn');
        const authUsernameInput = document.getElementById('username');
        const authPasswordInput = document.getElementById('password');
        const authMessageLog = document.getElementById('auth-message-log');

        // --- App UI Elements ---
        const appContainer = document.getElementById('app-container');
        const welcomeUsername = document.getElementById('welcome-username');
        const logoutBtn = document.getElementById('logout-btn');

        // --- Tab UI Elements ---
        const tabStream = document.getElementById('tab-stream');
        const tabUsers = document.getElementById('tab-users');
        const tabSettings = document.getElementById('tab-settings');
        const streamPanel = document.getElementById('stream-panel');
        const usersPanel = document.getElementById('users-panel');
        const settingsPanel = document.getElementById('settings-panel');

        // --- Stream Control UI Elements ---
        const streamUrlInput = document.getElementById('stream-url');
        const startBtn = document.getElementById('start-btn');
        const stopBtn = document.getElementById('stop-btn');
        const statusIndicator = document.getElementById('status-indicator');
        const statusDot = document.getElementById('status-dot');
        const statusText = document.getElementById('status-text');
        const shareLinkBox = document.getElementById('share-link-box');
        const shareLink = document.getElementById('share-link');
        const copyBtn = document.getElementById('copy-btn');
        const copyFeedback = document.getElementById('copy-feedback');
        const messageLog = document.getElementById('message-log');
        
        // --- Viewer List UI Elements ---
        const viewerListContainer = document.getElementById('viewer-list-container');
        const viewerCount = document.getElementById('viewer-count');
        const viewerTableBody = document.getElementById('viewer-table-body');
        const noViewersRow = document.getElementById('no-viewers-row');
        
        // --- User Management UI Elements ---
        const addUserForm = document.getElementById('add-user-form');
        const newUsernameInput = document.getElementById('new-username');
        const newPasswordInput = document.getElementById('new-password');
        const userTableBody = document.getElementById('user-table-body');
        const noUsersRow = document.getElementById('no-users-row');
        const userMessageLog = document.getElementById('user-message-log');

        // --- Generic Modal UI Elements ---
        const modal = document.getElementById('confirmation-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalMessage = document.getElementById('modal-message');
        const modalCancelBtn = document.getElementById('modal-cancel-btn');
        const modalConfirmBtn = document.getElementById('modal-confirm-btn');

        // --- NEW: Settings Panel UI Elements ---
        const saveSettingsBtn = document.getElementById('save-settings-btn');
        const settingsMessageLog = document.getElementById('settings-message-log');
        // Buffer
        const bufferEnabledInput = document.getElementById('buffer-enabled');
        const bufferDelayInput = document.getElementById('buffer-delay');
        // Profiles
        const activeProfileSelect = document.getElementById('active-profile-select');
        const addProfileBtn = document.getElementById('add-profile-btn');
        const editProfileBtn = document.getElementById('edit-profile-btn');
        const deleteProfileBtn = document.getElementById('delete-profile-btn');

        // --- NEW: Profile Editor Modal UI Elements ---
        const profileEditorModal = document.getElementById('profile-editor-modal');
        const profileEditorForm = document.getElementById('profile-editor-form');
        const profileModalTitle = document.getElementById('profile-modal-title');
        const profileIdInput = document.getElementById('profile-id');
        const profileIsDefaultInput = document.getElementById('profile-is-default');
        const profileNameInput = document.getElementById('profile-name');
        const profileCommandInput = document.getElementById('profile-command');
        const modalSaveProfileBtn = document.getElementById('modal-save-profile-btn');
        const modalCancelProfileBtn = document.getElementById('modal-cancel-profile-btn');


        // Set public stream URL
        const publicStreamUrl = `http://${window.location.hostname}:8994/live.m3u8`;
        shareLink.value = publicStreamUrl;

        // --- General Message Loggers ---
        function logAuthMessage(message, isError = true) {
            authMessageLog.textContent = message;
            authMessageLog.className = isError 
                ? 'text-center text-red-400 mt-4 text-sm h-5' 
                : 'text-center text-green-400 mt-4 text-sm h-5';
            setTimeout(() => { authMessageLog.textContent = ''; }, 4000);
        }

        function logStreamMessage(message, isError = false) {
            messageLog.textContent = message;
            messageLog.className = isError 
                ? 'text-center text-red-400 mt-4 text-sm h-5' 
                : 'text-center text-green-400 mt-4 text-sm h-5';
            setTimeout(() => { messageLog.textContent = ''; }, 4000);
        }

        function logUserMessage(message, isError = false) {
            userMessageLog.textContent = message;
            userMessageLog.className = isError 
                ? 'text-center text-red-400 mb-4 text-sm h-5' 
                : 'text-center text-green-400 mb-4 text-sm h-5';
            setTimeout(() => { userMessageLog.textContent = ''; }, 4000);
        }

        function logSettingsMessage(message, isError = false) {
            settingsMessageLog.textContent = message;
            settingsMessageLog.className = isError 
                ? 'text-center text-red-400 mt-4 text-sm h-5' 
                : 'text-center text-green-400 mt-4 text-sm h-5';
            setTimeout(() => { settingsMessageLog.textContent = ''; }, 4000);
        }

        // --- UI State Management ---
        function showLoginPanel(hasUsers) {
            if (hasUsers) {
                // Normal login
                authTitle.textContent = 'Login';
                authSubtitle.textContent = 'Welcome back. Please log in to continue.';
                authBtn.textContent = 'Login';
                firstRunMessage.classList.add('hidden');
            } else {
                // First-run registration
                authTitle.textContent = 'Create Admin Account';
                authSubtitle.textContent = 'This will be the primary admin account.';
                authBtn.textContent = 'Register';
                firstRunMessage.classList.remove('hidden');
            }
            authContainer.style.display = 'block';
            appContainer.style.display = 'none';
        }

        function showAppPanel(username) {
            welcomeUsername.textContent = username;
            authContainer.style.display = 'none';
            appContainer.style.display = 'block';
            
            // On login, always default to stream tab and fetch status
            showTab('stream-panel');
            checkStatus(); 
            // Also pre-fetch the user list for the other tab
            fetchUsers();
        }

        function showTab(tabId) {
            const tabs = [tabStream, tabUsers, tabSettings];
            const panels = [streamPanel, usersPanel, settingsPanel];

            panels.forEach(panel => panel.classList.remove('active'));
            tabs.forEach(tab => {
                tab.classList.remove('active');
                tab.classList.add('inactive');
            });

            const activePanel = document.getElementById(tabId);
            const activeTab = document.querySelector(`[data-tab="${tabId}"]`);
            
            if (activePanel) activePanel.classList.add('active');
            if (activeTab) {
                activeTab.classList.add('active');
                activeTab.classList.remove('inactive');
            }

            // Load data when switching to a data-heavy tab
            if (tabId === 'users-panel') {
                fetchUsers();
            } else if (tabId === 'settings-panel') {
                loadSettingsAndProfiles();
            }
        }

        // --- Auth API Functions ---

        async function checkAuthStatus() {
            try {
                const response = await fetch(`${apiUrl}/auth/check`);
                const data = await response.json();
                
                authState.isLoggedIn = data.loggedIn;
                authState.hasUsers = data.hasUsers;
                authState.username = data.username || '';

                if (authState.isLoggedIn) {
                    showAppPanel(authState.username);
                } else {
                    showLoginPanel(authState.hasUsers);
                }
            } catch (error) {
                console.error('Failed to check auth status:', error);
                logAuthMessage('Cannot connect to server.');
                showLoginPanel(true); // Default to login if server check fails
            }
        }

        async function handleAuthFormSubmit(e) {
            e.preventDefault();
            const username = authUsernameInput.value;
            const password = authPasswordInput.value;

            if (!username || !password) {
                logAuthMessage('Username and password are required.');
                return;
            }

            let url;
            let action;

            if (authState.hasUsers) {
                url = `${apiUrl}/auth/login`;
                action = 'Logging in...';
            } else {
                if (password.length < 4) {
                    logAuthMessage('Password must be at least 4 characters long.');
                    return;
                }
                url = `${apiUrl}/auth/register`;
                action = 'Registering...';
            }
            authBtn.textContent = action;
            authBtn.disabled = true;

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });

                const data = await response.json();
                if (response.ok) {
                    await checkAuthStatus();
                } else {
                    logAuthMessage(data.error || 'An unknown error occurred.');
                }
            } catch (error) {
                console.error('Auth error:', error);
                logAuthMessage('Failed to authenticate.');
            } finally {
                authBtn.textContent = authState.hasUsers ? 'Login' : 'Register';
                authBtn.disabled = false;
            }
        }

        async function handleLogout() {
            try {
                await fetch(`${apiUrl}/auth/logout`, { method: 'POST' });
            } catch (error) {
                console.error('Logout error:', error);
            } finally {
                authState.isLoggedIn = false;
                stopViewerCheck();
                await checkAuthStatus();
                authUsernameInput.value = '';
                authPasswordInput.value = '';
            }
        }


        // --- User Management API Functions ---

        async function fetchUsers() {
            try {
                const response = await fetchWithAuth(`${apiUrl}/users`);
                const users = await response.json();
                
                userTableBody.innerHTML = ''; // Clear table
                if (users.length === 0) {
                    userTableBody.appendChild(noUsersRow);
                    return;
                }

                users.forEach(user => {
                    const row = document.createElement('tr');
                    row.className = "hover:bg-gray-700 transition-colors duration-150";
                    row.innerHTML = `
                        <td class="p-3 text-sm text-gray-200">${user.username}</td>
                        <td class="p-3 text-sm text-gray-400 font-mono">${user.id}</td>
                        <td class="p-3 text-sm">
                            <button class="delete-user-btn bg-red-600 hover:bg-red-700 text-white text-xs font-bold py-1 px-2 rounded-md shadow" data-id="${user.id}" data-username="${user.username}">
                                Delete
                            </button>
                        </td>
                    `;
                    userTableBody.appendChild(row);
                });

            } catch (error) {
                console.error('Error fetching users:', error);
                logUserMessage(error.message, true);
            }
        }

        async function handleAddUser(e) {
            e.preventDefault();
            const username = newUsernameInput.value;
            const password = newPasswordInput.value;

            if (!username || !password) {
                logUserMessage('Username and password are required', true);
                return;
            }
            if (password.length < 4) {
                logUserMessage('Password must be at least 4 chars', true);
                return;
            }

            try {
                const response = await fetchWithAuth(`${apiUrl}/auth/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                const data = await response.json();
                
                if (response.ok) {
                    logUserMessage(`User '${data.username}' created!`, false);
                    newUsernameInput.value = '';
                    newPasswordInput.value = '';
                    await fetchUsers(); // Refresh list
                } else {
                    logUserMessage(data.error || 'Failed to create user', true);
                }
            } catch (error) {
                console.error('Error adding user:', error);
                logUserMessage(error.message, true);
            }
        }

        async function handleDeleteUser(userId, username) {
            try {
                const response = await fetchWithAuth(`${apiUrl}/users/${userId}`, {
                    method: 'DELETE'
                });
                const data = await response.json();
                if (response.ok) {
                    logUserMessage(`User '${username}' deleted.`, false);
                    await fetchUsers(); // Refresh list
                } else {
                    logUserMessage(data.error || 'Failed to delete user', true);
                }
            } catch (error) {
                console.error('Error deleting user:', error);
                logUserMessage(error.message, true);
            }
        }


        // --- Stream Control API Functions ---

        function updateStatus(running, url = "") {
            if (running) {
                statusIndicator.classList.remove('border-red-500');
                statusIndicator.classList.add('border-green-500');
                statusIndicator.style.borderColor = 'rgba(34, 197, 94, 0.5)';
                statusIndicator.style.background = 'rgba(34, 197, 94, 0.1)';
                statusDot.classList.remove('bg-red-500');
                statusDot.classList.add('bg-green-500');
                statusText.textContent = 'Stream is LIVE';
                shareLinkBox.style.display = 'block';
                streamUrlInput.value = url;
                
                viewerListContainer.style.display = 'block';
                startViewerCheck();
                fetchViewers();
            } else {
                statusIndicator.classList.remove('border-green-500');
                statusIndicator.classList.add('border-red-500');
                statusIndicator.style.borderColor = 'rgba(239, 68, 68, 0.5)';
                statusIndicator.style.background = 'rgba(239, 68, 68, 0.1)';
                statusDot.classList.remove('bg-green-500');
                statusDot.classList.add('bg-red-500');
                statusText.textContent = 'Stream is OFFLINE';
                shareLinkBox.style.display = 'none';
                
                viewerListContainer.style.display = 'none';
                stopViewerCheck();
                clearViewerTable();
            }
        }

        async function checkStatus() {
            if (!authState.isLoggedIn) return; 
            try {
                const response = await fetchWithAuth(`${apiUrl}/status`);
                const data = await response.json();
                updateStatus(data.running, data.url);
            } catch (error) {
                console.error('Failed to check status:', error);
                logStreamMessage(error.message, true);
                updateStatus(false);
            }
        }

        async function handleStartStream() {
            const url = streamUrlInput.value;
            if (!url) {
                logStreamMessage('Please paste the stream link first', true);
                return;
            }

            try {
                const response = await fetchWithAuth(`${apiUrl}/start`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url })
                });
                const data = await response.json();
                if (response.ok) {
                    logStreamMessage('Stream started!', false);
                    updateStatus(true, url);
                } else {
                    logStreamMessage(data.error || 'Failed to start stream', true);
                }
            } catch (error) {
                console.error('Error starting stream:', error);
                logStreamMessage(error.message, true);
            }
        }

        async function handleStopStream() {
            try {
                const response = await fetchWithAuth(`${apiUrl}/stop`, { method: 'POST' });
                const data = await response.json();
                if (response.ok) {
                    logStreamMessage('Stream stopped', false);
                    updateStatus(false);
                    streamUrlInput.value = '';
                } else {
                    logStreamMessage(data.error || 'Failed to stop stream', true);
                }
            } catch (error) {
                console.error('Error stopping stream:', error);
                logStreamMessage(error.message, true);
            }
        }

        function handleCopy() {
            shareLink.select();
            try {
                document.execCommand('copy');
                copyFeedback.style.display = 'block';
                setTimeout(() => { copyFeedback.style.display = 'none'; }, 2000);
            } catch (err) {
                console.error('Failed to copy text: ', err);
                logStreamMessage('Failed to copy link', true);
            }
        }

        // --- Viewer List Functions ---

        function formatTimeAgo(timestamp) {
            const now = Date.now();
            const seconds = Math.floor((now - timestamp) / 1000);
            if (seconds < 10) return "just now";
            if (seconds < 60) return `${seconds}s ago`;
            const minutes = Math.floor(seconds / 60);
            if (minutes < 60) return `${minutes}m ago`;
            const hours = Math.floor(minutes / 60);
            return `${hours}h ago`;
        }

        function clearViewerTable() {
            viewerTableBody.innerHTML = '';
            viewerTableBody.appendChild(noViewersRow);
            viewerCount.textContent = '0';
        }

        async function fetchViewers() {
            if (!authState.isLoggedIn) return; 
            try {
                const response = await fetchWithAuth(`${apiUrl}/viewers`);
                const viewers = await response.json();
                viewerCount.textContent = viewers.length;
                viewerTableBody.innerHTML = '';

                if (viewers.length === 0) {
                    viewerTableBody.appendChild(noViewersRow);
                    return;
                }

                viewers.forEach(viewer => {
                    const row = document.createElement('tr');
                    row.className = "hover:bg-gray-700 transition-colors duration-150";
                    const isBlocked = viewer.isBlocked;
                    const buttonHtml = isBlocked
                        ? `<button class="bg-gray-500 text-gray-300 text-xs font-bold py-1 px-2 rounded-md" disabled>Terminated</button>`
                        : `<button class="terminate-btn bg-red-600 hover:bg-red-700 text-white text-xs font-bold py-1 px-2 rounded-md shadow" data-ip="${viewer.ip}">Terminate</button>`;

                    row.innerHTML = `
                        <td class="p-3 text-sm text-gray-200 font-mono">${viewer.ip}</td>
                        <td class="p-3 text-sm text-gray-300">${formatTimeAgo(viewer.firstSeen)}</td>
                        <td class="p-3 text-sm text-green-400 font-medium">${formatTimeAgo(viewer.lastSeen)}</td>
                        <td class="p-3 text-sm">${buttonHtml}</td>
                    `;
                    viewerTableBody.appendChild(row);
                });

            } catch (error) {
                console.error('Error fetching viewers:', error);
                logStreamMessage(error.message, true);
            }
        }

        function startViewerCheck() {
            if (viewerCheckInterval) return;
            viewerCheckInterval = setInterval(fetchViewers, 5000);
        }

        function stopViewerCheck() {
            if (viewerCheckInterval) {
                clearInterval(viewerCheckInterval);
                viewerCheckInterval = null;
            }
        }

        async function terminateIp(ip) {
             try {
                const response = await fetchWithAuth(`${apiUrl}/terminate`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ip: ip })
                });
                const data = await response.json();
                if (response.ok) {
                    logStreamMessage(data.message || `Terminated ${ip}`, false);
                    fetchViewers();
                } else {
                    logStreamMessage(data.message || data.error || 'Failed to terminate', true);
                }
            } catch (error) {
                console.error('Error terminating IP:', error);
                logStreamMessage(error.message, true);
            }
        }

        // --- Modal Functions ---
        function showModal(modalElement) {
            modalElement.classList.remove('hidden');
            modalElement.classList.add('visible');
        }

        function hideModal(modalElement) {
            modalElement.classList.add('hidden');
            modalElement.classList.remove('visible');
        }

        function showConfirmModal({ title, message, onConfirm }) {
            modalTitle.textContent = title;
            modalMessage.innerHTML = message;
            pendingConfirmAction = onConfirm;
            showModal(modal);
        }

        // --- NEW: Settings & Profile Functions ---

        // Fetches ALL settings from the server and caches them
        async function loadSettingsAndProfiles() {
            try {
                const response = await fetchWithAuth(`${apiUrl}/settings`);
                const data = await response.json();
                globalSettings = data; // Store in global cache

                // Populate Buffer UI
                bufferEnabledInput.checked = globalSettings.buffer.enabled;
                bufferDelayInput.value = globalSettings.buffer.delaySeconds;
                
                // Populate Profiles UI
                populateProfileSelect(globalSettings.profiles, globalSettings.activeProfileId);

            } catch (error) {
                logSettingsMessage(error.message, true);
            }
        }

        // Saves the ENTIRE settings object to the server
        async function saveAllSettings() {
            try {
                // 1. Read buffer settings from UI into global cache
                globalSettings.buffer.enabled = bufferEnabledInput.checked;
                globalSettings.buffer.delaySeconds = parseInt(bufferDelayInput.value, 10) || 30;

                // 2. Read active profile ID from dropdown into global cache
                globalSettings.activeProfileId = activeProfileSelect.value;
                
                // 3. (Profile array is already updated in the cache by the editor functions)

                const response = await fetchWithAuth(`${apiUrl}/settings`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(globalSettings)
                });
                const data = await response.json();
                
                if (response.ok) {
                    globalSettings = data; // Re-sync with the saved version
                    populateProfileSelect(globalSettings.profiles, globalSettings.activeProfileId);
                    logSettingsMessage('Settings saved successfully!', false);
                } else {
                    logSettingsMessage(data.error || 'Failed to save settings', true);
                }
            } catch (error) {
                logSettingsMessage(error.message, true);
            }
        }

        // Populates the dropdown with profiles
        function populateProfileSelect(profiles = [], activeId = null) {
            activeProfileSelect.innerHTML = '';
            profiles.forEach(profile => {
                const option = document.createElement('option');
                option.value = profile.id;
                option.textContent = profile.name + (profile.isDefault ? ' (Default)' : '');
                if (profile.id === activeId) {
                    option.selected = true;
                }
                activeProfileSelect.appendChild(option);
            });
            updateProfileButtonStates();
        }

        // Enables/disables edit/delete buttons based on selection
        function updateProfileButtonStates() {
            const selectedId = activeProfileSelect.value;
            const selectedProfile = globalSettings.profiles.find(p => p.id === selectedId);
            
            if (!selectedProfile) {
                editProfileBtn.disabled = true;
                deleteProfileBtn.disabled = true;
                return;
            }

            // You can edit defaults, but you can't delete them
            editProfileBtn.disabled = false;
            deleteProfileBtn.disabled = selectedProfile.isDefault === true;
        }

        // Opens the profile editor modal (for new or existing profiles)
        function openProfileEditor(profile) {
            profileEditorForm.reset();
            if (profile) {
                // Editing existing profile
                profileModalTitle.textContent = 'Edit Profile';
                profileIdInput.value = profile.id;
                profileIsDefaultInput.value = profile.isDefault || false;
                profileNameInput.value = profile.name;
                profileCommandInput.value = profile.command;

                // Default profiles can't be renamed or have their commands edited (protects user)
                const isDefault = profile.isDefault === true;
                profileNameInput.disabled = isDefault;
                profileCommandInput.disabled = isDefault;
                modalSaveProfileBtn.disabled = isDefault;

                if (isDefault) {
                    profileNameInput.title = "Default profiles cannot be edited.";
                    profileCommandInput.title = "Default profiles cannot be edited.";
                } else {
                    profileNameInput.title = "";
                    profileCommandInput.title = "";
                }

            } else {
                // Creating new profile
                profileModalTitle.textContent = 'Add New Profile';
                profileIdInput.value = `custom-${Date.now()}`; // New unique ID
                profileIsDefaultInput.value = false;
                
                profileNameInput.disabled = false;
                profileCommandInput.disabled = false;
                modalSaveProfileBtn.disabled = false;
            }
            showModal(profileEditorModal);
        }

        // Saves the profile from the modal into the globalSettings cache
        function saveProfileFromModal(e) {
            e.preventDefault();
            const profileId = profileIdInput.value;
            const isDefault = profileIsDefaultInput.value === 'true';

            if (isDefault) {
                // This shouldn't happen since button is disabled, but as a safeguard
                hideModal(profileEditorModal);
                return;
            }

            const newProfileData = {
                id: profileId,
                name: profileNameInput.value,
                command: profileCommandInput.value,
                isDefault: false
            };

            // Find if this profile already exists to update it, or add if new
            const existingIndex = globalSettings.profiles.findIndex(p => p.id === profileId);
            if (existingIndex > -1) {
                // Update existing
                globalSettings.profiles[existingIndex] = newProfileData;
            } else {
                // Add new
                globalSettings.profiles.push(newProfileData);
            }
            
            // Set the new/edited profile as the active one
            globalSettings.activeProfileId = newProfileData.id;

            // Now, save the *entire* settings object (which includes the updated profiles array) to server
            saveAllSettings(); // This function also re-populates the select box
            hideModal(profileEditorModal);
        }

        // Deletes the selected profile from the globalSettings cache
        function deleteSelectedProfile() {
            const selectedId = activeProfileSelect.value;
            const selectedProfile = globalSettings.profiles.find(p => p.id === selectedId);

            if (!selectedProfile || selectedProfile.isDefault) {
                logSettingsMessage('Cannot delete a default profile.', true);
                return;
            }

            showConfirmModal({
                title: 'Delete Profile',
                message: `Are you sure you want to delete profile <strong class="text-red-400">${selectedProfile.name}</strong>?`,
                onConfirm: () => {
                    // Filter the profile out of the array
                    globalSettings.profiles = globalSettings.profiles.filter(p => p.id !== selectedId);
                    
                    // Set active profile back to the first default one
                    globalSettings.activeProfileId = globalSettings.profiles.find(p => p.isDefault).id;
                    
                    // Save the entire updated settings object
                    saveAllSettings(); // This also refreshes the select box
                }
            });
        }


        // --- Generic Authed Fetch Wrapper ---
        // Wraps fetch() and handles 401 Unauthorized errors automatically
        async function fetchWithAuth(url, options = {}) {
            const response = await fetch(url, options);

            if (response.status === 401) {
                // Unauthorized! Session likely expired.
                logAuthMessage('Session expired. Please log in again.');
                await handleLogout(); // This will reset the UI to the login screen
                // Throw an error to stop the original function from continuing
                throw new Error('Session expired');
            }

            if (!response.ok) {
                // Pass other errors (like 400, 404, 500) up the chain
                const data = await response.json();
                throw new Error(data.error || `Server error: ${response.status}`);
            }

            return response; // Return the successful response
        }
        
        // --- Event Listeners ---

        // Auth
        authForm.addEventListener('submit', handleAuthFormSubmit);
        logoutBtn.addEventListener('click', handleLogout);
        
        // Tabs
        tabStream.addEventListener('click', () => showTab('stream-panel'));
        tabUsers.addEventListener('click', () => showTab('users-panel'));
        tabSettings.addEventListener('click', () => showTab('settings-panel'));

        // Stream Control
        startBtn.addEventListener('click', handleStartStream);
        stopBtn.addEventListener('click', handleStopStream);
        copyBtn.addEventListener('click', handleCopy);

        // User Management
        addUserForm.addEventListener('submit', handleAddUser);
        userTableBody.addEventListener('click', (e) => {
            if (e.target && e.target.classList.contains('delete-user-btn')) {
                const id = e.target.getAttribute('data-id');
                const username = e.target.getAttribute('data-username');
                if (id && username) {
                    showConfirmModal({
                        title: 'Delete User',
                        message: `Are you sure you want to delete user <strong class="text-red-400">${username}</strong>? This is irreversible.`,
                        onConfirm: () => handleDeleteUser(id, username)
                    });
                }
            }
        });

        // Viewer List
        viewerTableBody.addEventListener('click', (e) => {
            if (e.target && e.target.classList.contains('terminate-btn')) {
                const ip = e.target.getAttribute('data-ip');
                if (ip) {
                    showConfirmModal({
                        title: 'Confirm Termination',
                        message: `Are you sure you want to terminate the stream for <strong class="text-red-400">${ip}</strong>? This is irreversible.`,
                        onConfirm: () => terminateIp(ip)
                    });
                }
            }
        });

        // Generic Modal
        modalCancelBtn.addEventListener('click', () => hideModal(modal));
        modalConfirmBtn.addEventListener('click', () => {
            if (pendingConfirmAction) {
                pendingConfirmAction();
            }
            hideModal(modal);
        });

        // --- NEW: Settings Panel Listeners ---
        saveSettingsBtn.addEventListener('click', saveAllSettings);
        activeProfileSelect.addEventListener('change', updateProfileButtonStates);

        // Profile Editor
        addProfileBtn.addEventListener('click', () => openProfileEditor(null));
        editProfileBtn.addEventListener('click', () => {
            const selectedId = activeProfileSelect.value;
            const profile = globalSettings.profiles.find(p => p.id === selectedId);
            if (profile) openProfileEditor(profile);
        });
        deleteProfileBtn.addEventListener('click', deleteSelectedProfile);
        
        // Profile Modal
        profileEditorForm.addEventListener('submit', saveProfileFromModal);
        modalCancelProfileBtn.addEventListener('click', () => hideModal(profileEditorModal));


        // --- Initial Load ---
        authContainer.style.display = 'block';
        document.addEventListener('DOMContentLoaded', checkAuthStatus);
        
        setInterval(checkStatus, 10000);
    </script>
</body>
</html>
